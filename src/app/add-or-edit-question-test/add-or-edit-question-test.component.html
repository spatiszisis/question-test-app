@defer (when !loading()) {
<form
  *ngIf="questionTestForm !== undefined"
  [formGroup]="questionTestForm"
  (ngSubmit)="onSubmit()"
  class="grid grid-cols-1 sm:grid-cols-12 grid-rows-12 gap-4 h-dvh bg-white px-6 py-24 sm:py-32 lg:px-8"
>
  <div class="col-span-1 sm:col-span-4 row-span-2 md:row-span-12">
    <div class="flex items-center">
      <a [routerLink]="['/intro']" class="cursor-pointer">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="w-6 h-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"
          />
        </svg>
      </a>
      <h2
        class="text-center text-2xl font-bold leading-9 tracking-tight text-gray-900 ml-3"
      >
        {{
          existingQuestionTest
            ? "Edit the question test"
            : "Create a question test"
        }}
      </h2>
    </div>

    <div class="mt-5" *ngIf="!existingQuestionTest || uploadedFile">
      <app-upload-file
        [uploadedFile]="uploadedFile"
        (filesUploaded)="onFilesUploaded($event)"
      ></app-upload-file>

      <p class="text-center text-lg my-5">or</p>
    </div>

    <div class="mt-2">
      <label
        for="title"
        class="block text-sm font-medium leading-6 text-gray-900"
        >Group title</label
      >
      <div class="mt-2">
        <input
          id="title"
          type="text"
          formControlName="title"
          autocomplete="off"
          required
          class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"
        />
      </div>
    </div>

    <div class="flex flex-col mt-5">
      <button
        type="submit"
        class="flex w-full justify-center rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-indigo-500"
      >
        @if (loadingUpdateOrAdd()) {
        <span>
          <span
            class="spinner-border spinner-border-sm"
            role="status"
            aria-hidden="true"
          ></span>
          Loading...
        </span>
        } @else {
        <span>
          {{ route.snapshot.params.id ? "Edit" : "Submit" }}
        </span>
        }
      </button>
      <ng-container *ngIf="route.snapshot.params.id">
        <hr class="my-2" />
        <div class="flex items-center gap-4">
          <button
            type="button"
            (click)="exportToJson()"
            class="w-full select-none rounded-lg bg-slate-600 py-3 px-6 text-center align-middle font-sans text-xs font-bold uppercase text-white shadow-md shadow-gray-900/10 transition-all hover:shadow-lg hover:shadow-gray-900/20 focus:opacity-[0.85] focus:shadow-none active:opacity-[0.85] active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none"
          >
            Export to JSON
          </button>
          <button
            type="button"
            data-modal-target="deleteModal"
            data-modal-toggle="deleteModal"
            class="w-full select-none rounded-lg bg-red-600 py-3 px-6 text-center align-middle font-sans text-xs font-bold uppercase text-white shadow-md shadow-gray-900/10 transition-all hover:shadow-lg hover:shadow-gray-900/20 focus:opacity-[0.85] focus:shadow-none active:opacity-[0.85] active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none"
          >
            Delete
          </button>
        </div>
      </ng-container>
    </div>
  </div>
  <div
    class="col-span-1 sm:col-span-8 row-span-10 md:row-span-12 flex flex-col mt-20 sm:mt-0"
  >
    <div class="flex items-center justify-around">
      <p class="text-lg leading-3 font-bold">Questions</p>
      <button
        (click)="addQuestion()"
        type="button"
        class="flex justify-center rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
      >
        Add question
      </button>
    </div>

    <div
      id="questionsList"
      formArrayName="questions"
      class="overflow-y-auto p-4 space-y-6"
    >
      <div
        *ngFor="
          let control of questionsArray().controls;
          let questionIndex = index
        "
      >
        <div [formGroupName]="questionIndex">
          <div class="grid divide-y divide-neutral-200 max-w-xl mx-auto mt-2">
            <div class="py-5">
              <details class="group" [id]="'question' + questionIndex">
                <summary
                  class="flex justify-between items-center font-medium cursor-pointer list-none"
                >
                  <span>Question {{ questionIndex + 1 }}</span>
                  <span class="transition group-open:rotate-180">
                    <svg
                      fill="none"
                      height="24"
                      shape-rendering="geometricPrecision"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="1.5"
                      viewBox="0 0 24 24"
                      width="24"
                    >
                      <path d="M6 9l6 6 6-6"></path>
                    </svg>
                  </span>
                </summary>
                <div class="mt-2 flex flex-col">
                  <div class="flex items-center justify-between">
                    <label
                      [for]="'questionTitle' + questionIndex"
                      class="block text-sm font-medium leading-6 text-gray-900"
                      >Question Title</label
                    >
                    <button
                      (click)="removeQuestion(questionIndex)"
                      type="button"
                      class="text-sm font-semibold leading-6 text-red-600"
                    >
                      Delete
                    </button>
                  </div>
                  <textarea
                    [id]="'questionTitle' + questionIndex"
                    type="text"
                    formControlName="question"
                    autocomplete="off"
                    required
                    class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"
                  ></textarea>
                </div>

                <div class="mt-3 flex items-center justify-between">
                  <div class="flex flex-col">
                    <h3>Images</h3>
                    <span
                      *ngIf="questionImages(questionIndex).controls.length"
                      class="font-bold"
                      >You have
                      {{ questionImages(questionIndex).controls.length }}
                      uploaded.</span
                    >
                  </div>

                  <button
                    type="button"
                    class="text-sm font-semibold leading-6 text-blue-600"
                    (click)="selectedQuestion(questionIndex)"
                  >
                    {{
                      questionImages(questionIndex).controls.length
                        ? "Edit Images"
                        : "Add Image"
                    }}
                  </button>
                </div>

                <!-- <div class="mt-3 bg-slate-200">
                  <div class="flex items-center justify-between">
                    <div class="flex flex-col w-full">
                      <label
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                        [id]="'questionImages' + questionIndex"
                        >Upload file</label
                      >
                      <input
                        class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"
                        [id]="'questionImages' + questionIndex"
                        type="file"
                        #fileDropRef
                        multiple
                        (change)="chooseFile($event, questionIndex)"
                      />
                    </div>
                  </div>
                  <div class="mt-3 flex items-center gap-2">
                    <div
                      class=""
                      *ngFor="
                        let uploadedSrcImage of uploadedSrcImages;
                        let uploadedSrcImageIndex = index
                      "
                    >
                      <img
                        [src]="uploadedSrcImage"
                        [alt]="uploadedSrcImage"
                        class="w-14"
                      />
                      <div class="flex items-center justify-around">
                        <button
                          class="text-sm font-semibold leading-6 text-black"
                          type="button"
                          data-popover-target="popover-default"
                        >
                          Show
                        </button>

                        <div
                          data-popover
                          id="popover-default"
                          role="tooltip"
                          class="absolute z-50 invisible inline-block w-64 text-sm text-gray-500 transition-opacity duration-300 bg-white border border-gray-200 rounded-lg shadow-sm opacity-0 dark:text-gray-400 dark:border-gray-600 dark:bg-gray-800"
                        >
                          <div
                            class="px-3 py-2 bg-gray-100 border-b border-gray-200 rounded-t-lg dark:border-gray-600 dark:bg-gray-700"
                          >
                            <h3
                              class="font-semibold text-gray-900 dark:text-white"
                            >
                              Show Image
                            </h3>
                          </div>
                          <div class="px-3 py-2">
                            <img
                              [src]="uploadedSrcImage"
                              [alt]="uploadedSrcImage"
                            />
                          </div>
                          <div data-popper-arrow></div>
                        </div>
                        <button
                          (click)="removeUploadedImage(uploadedSrcImageIndex)"
                          type="button"
                          class="text-sm font-semibold leading-6 text-red-600"
                        >
                          <i class="fa-solid fa-xmark"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div> -->

                <div class="flex items-center justify-between mt-5">
                  <h2>Answers</h2>
                  <button
                    type="button"
                    (click)="addAnswer(questionIndex)"
                    class="flex justify-center rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
                  >
                    Add answer
                  </button>
                </div>

                <div formArrayName="answers">
                  <div
                    *ngFor="
                      let control of answersArray(questionIndex).controls;
                      let answerIndex = index
                    "
                  >
                    <div [formGroupName]="answerIndex">
                      <div class="mt-2 flex flex-col gap-1">
                        <div class="flex flex-col">
                          <div class="flex items-center justify-between">
                            <label
                              [for]="'answer' + answerIndex"
                              class="block text-sm font-medium leading-6 text-gray-900"
                              >Answer Title</label
                            >
                            <button
                              (click)="removeAnswer(questionIndex, answerIndex)"
                              type="button"
                              class="text-sm font-semibold leading-6 text-red-600"
                            >
                              Delete
                            </button>
                          </div>
                          <input
                            [id]="'answer' + answerIndex"
                            type="text"
                            formControlName="answer"
                            autocomplete="off"
                            required
                            class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"
                          />
                        </div>
                        <div class="flex flex-col">
                          <label
                            class="block text-sm font-medium leading-6 text-gray-900"
                            [for]="'isCorrect' + answerIndex"
                            data-ripple-dark="true"
                          >
                            Is correct?
                          </label>
                          <input
                            type="checkbox"
                            formControlName="isCorrect"
                            class="before:content[''] peer relative h-5 w-5 cursor-pointer appearance-none rounded-md border border-blue-gray-200 transition-all before:absolute before:top-2/4 before:left-2/4 before:block before:h-12 before:w-12 before:-translate-y-2/4 before:-translate-x-2/4 before:rounded-full before:bg-blue-gray-500 before:opacity-0 before:transition-opacity checked:border-blue-500 checked:bg-blue-500 checked:before:bg-blue-500 hover:before:opacity-10"
                            [id]="'isCorrect' + answerIndex"
                          />
                          <div
                            class="pointer-events-none absolute top-2/4 left-2/4 -translate-y-2/4 -translate-x-2/4 text-white opacity-0 transition-opacity peer-checked:opacity-100"
                          >
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              class="h-3.5 w-3.5"
                              viewBox="0 0 20 20"
                              fill="currentColor"
                              stroke="currentColor"
                              stroke-width="1"
                            >
                              <path
                                fill-rule="evenodd"
                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                clip-rule="evenodd"
                              ></path>
                            </svg>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </details>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>
} @loading {
<div class="h-screen bg-white">
  <div class="flex justify-center items-center h-full">
    <img
      class="h-16 w-16"
      src="https://icons8.com/preloaders/preloaders/1488/Iphone-spinner-2.gif"
      alt=""
    />
  </div>
</div>
}

<!-- Delete modal -->
<div
  id="deleteModal"
  tabindex="-1"
  aria-hidden="true"
  class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full"
>
  <div class="relative w-full max-w-2xl max-h-full">
    <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
      <div
        class="flex items-start justify-between p-4 border-b rounded-t dark:border-gray-600"
      >
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
          Are you sure you want to delete this question test?
        </h3>
        <button
          type="button"
          class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white"
          data-modal-hide="deleteModal"
        >
          <svg
            aria-hidden="true"
            class="w-5 h-5"
            fill="currentColor"
            viewBox="0 0 20 20"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
              clip-rule="evenodd"
            ></path>
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      <div
        class="flex items-center justify-end p-6 space-x-2 border-t border-gray-200 rounded-b dark:border-gray-600"
      >
        <button
          data-modal-hide="deleteModal"
          type="button"
          class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5"
        >
          Cancel
        </button>
        <button
          (click)="onDelete()"
          data-modal-hide="deleteModal"
          type="button"
          class="text-white bg-red-600 hover:bg-red-500 focus:ring-4 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5"
        >
          Yes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- <button
                      type="button"
                      class="text-sm font-semibold leading-6 text-indigo-600"
                      (click)="uploadFile()"
                    >
                      @defer (when uploading()) { Uploaded } @placeholder {
                      Upload } @loading(minimum 1s) { Uploading...}
                    </button> -->

<!-- Main modal -->

<app-image-modal *ngIf="!!selectedQuestionIndex" [images]="questionImages(selectedQuestionIndex).controls" [selectedQuestionIndex]="selectedQuestionIndex"></app-image-modal>
